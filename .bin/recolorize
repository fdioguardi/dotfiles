#!/bin/sh

# Recolorize
# A wrapper for paintee

# If you have a script to change the color of an app based on either
# .Xresources or ~/.cache/paintee, call it inside this function
update_apps()
{
  # Bspwm
  ${XDG_CONFIG_HOME:-"$HOME/.config"}/bspwm/config/color_setup.sh &

  if [ -z "$quickstart" ]; then

    # Kitty
    ${XDG_CONFIG_HOME:-"$HOME/.config"}/kitty/colorize_kitty.sh &

    # Zathura
    ${XDG_CONFIG_HOME:-"$HOME/.config"}/zathura/genzathurarc.sh &
  fi
}

usage()
{
  echo "Usage: $( basename "$0" ) (-a | [-c PATH] [-x PATH] [FILE])" >&2
}

update_colors()
{
  xrdb "${xresources_path}"
  [ "${xresources_path}" != "${color_path}/${color_basename}" ] &&
    xrdb -merge "${color_path}/${color_basename}"
  }

cache_colors()
{
  paintee
  echo "
  Current color scheme: '${color_path}/${color_basename}'
  Current Xresources file: '${xresources_path}'
  Updated: $(date)" >> "${cache_file}"
}

set_xresources_path()
{
  [ ! -f "$1" ] && echo "$1 is not a file" && exit 2
  xresources_path=$1
}

set_color_path()
{
  [ ! -d "$1" ] && echo "$1 is not a directory" && exit 2
  color_path=$1
}

get_colorscheme()
{
  current_colorscheme=$(grep "color scheme" "${cache_file}")
  current_colorscheme="${current_colorscheme##*/}"
  echo "${current_colorscheme%?}"
}

set_color_basename()
{
  [ -n "$1" ] && \
    [ ! -f "${color_path}"/"$1" ] && \
    echo "${color_path}/$1 does not exist" && \
    exit 2

  color_basename=${1:-$(basename "$(shuf -n1 -e "${color_path}"/*)")}
}

main()
{
  cache_file="${HOME}/.cache/paintee"

  while getopts 'ac:x:q' opt; do
    case "${opt}" in
      a)
        get_colorscheme
        exit 0
        ;;

      c) set_color_path "${OPTARG}" ;;

      x) set_xresources_path "${OPTARG}" ;;

      q) quickstart=true ;;

      ?)
        usage
        exit 22
        ;;
    esac
  done
  shift "$((OPTIND - 1))"

  [ $# -gt 1 ] && usage && exit 7

  # Default colorsâ€™ path
  [ -z "${color_path}" ] && set_color_path "${XDG_CONFIG_HOME}/colorschemes"

  set_color_basename "$1"

  [ -z "${xresources_path}" ] && \
    set_xresources_path "${color_path}/${color_basename}"

  update_colors
  cache_colors &
  update_apps

  # This script might fail, loop, or provoque inconsistent states, if called a #
  # second time right after the first one finished. To avoid this, uncomment   #
  # the line bellow, at the cost of efficiency.                                #
  # If you chose to leave it commented out and the script fails in any way,    #
  # just kill it with Ctrl-c and re execute.                                   #

  # wait
}

main "$@"
